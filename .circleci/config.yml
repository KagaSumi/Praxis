version: 2.1

# Define reusable executors for consistency
executors:
  default-executor:
    docker:
      # Use a standard Docker image with Node, Python, and other tools,
      # which is common for full-stack apps.
      - image: cimg/base:2024.08

# Define reusable commands to check for changes and run tests/builds
commands:
  # Command to check if a specific directory has changes compared to the 'main' branch
  check_for_changes:
    parameters:
      path:
        type: string
        description: The directory path to check for changes (e.g., Backend/)
      test_command:
        type: string
        description: The command to run if changes are detected

    steps:
      - run:
          name: Check changes in << parameters.path >> and run tests
          # Get the merge-base (common ancestor) between the current branch and main
          # This helps accurately determine what files are new or modified.
          command: |
            echo "--- Checking for changes in << parameters.path >> ---"
            # Fallback to main if merge-base fails (e.g., first commit on a branch)
            BASE_COMMIT=$(git merge-base HEAD main || echo "main")

            # Check if any file in the specified path has been modified since BASE_COMMIT
            if git diff --quiet $BASE_COMMIT HEAD -- << parameters.path >>; then
              echo "No changes detected in << parameters.path >>. Skipping tests."
            else
              echo "Changes detected in << parameters.path >>. Running tests..."
              # Execute the test command
              eval '<< parameters.test_command >>'
            fi

jobs:
  # Job 1: Install dependencies and setup Git history for accurate diffing
  setup_and_install:
    executor: default-executor
    steps:
      - checkout
      # Fetch main branch history to compare changes against
      - run: git fetch origin main --depth=10
      - persist_to_workspace:
          root: .
          paths:
            - .

  # Job 2: Run conditional tests for Database, Backend, and Frontend
  run_conditional_tests:
    executor: default-executor
    steps:
      - attach_workspace:
          at: .

      # Step 1: Database Tests (e.g., using a simple shell script or DB migration test)
      - check_for_changes:
          path: Database/
          test_command: |
            # Example setup for running database-related checks/tests
            echo "Database: Running schema validation/test."
            # cd Database/
            # npm install (if node-based) or pip install (if python-based)
            # npm run test:db
            echo "Database tests passed."

      # Step 2: Backend Tests (e.g., a Node.js or Python backend)
      - check_for_changes:
          path: Backend/
          test_command: |
            echo "Backend: Installing dependencies and running unit tests."
            # For a Node.js backend:
            cd Backend/
            npm install
            npm test
            cd ..
            echo "Backend tests passed."

      # Step 3: Frontend Tests (e.g., React/Vue/Angular tests)
      - check_for_changes:
          path: Frontend/
          test_command: |
            echo "Frontend: Installing dependencies and running unit/integration tests."
            # For a React/Node.js frontend:
            cd Frontend/
            npm install
            npm run test -- --watchAll=false
            cd ..
            echo "Frontend tests passed."

  # Job 3: Build and Push Docker Images
  build_and_push_docker:
    executor: default-executor
    # Requires DOCKER_USER and DOCKER_PASS environment variables to be set in CircleCI
    steps:
      - attach_workspace:
          at: .
      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Build and Push Docker Images
          command: |
            # Set the image tag to the commit SHA
            REPO=kagasumi/Praxis
            IMAGE_TAG=${CIRCLE_SHA1:0:7}

            # 1. Login to Docker Hub
            echo "Logging into Docker Hub..."
            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin

            # 2. Build the Backend Image
            echo "Building $REPO-backend:$IMAGE_TAG"
            docker build -t $REPO-backend:$IMAGE_TAG -f Backend/Dockerfile Backend/

            # 3. Build the Frontend Image
            echo "Building $REPO-frontend:$IMAGE_TAG"
            docker build -t $REPO-frontend:$IMAGE_TAG -f Frontend/Dockerfile Frontend/

            # 4. Push images to Docker Hub
            echo "Pushing images to Docker Hub..."
            docker push $REPO-backend:$IMAGE_TAG
            docker push $REPO-frontend:$IMAGE_TAG

            echo "Successfully pushed $REPO-backend:$IMAGE_TAG and $REPO-frontend:$IMAGE_TAG"


workflows:
  full_stack_ci_cd:
    jobs:
      - setup_and_install
      # Run all tests conditionally based on path changes
      - run_conditional_tests:
          requires:
            - setup_and_install

      # Docker Push Job: Only run if the current branch is NOT 'main'
      - build_and_push_docker:
          requires:
            - run_conditional_tests
          filters:
            branches:
              ignore:
                - main
              # You can also add specific branches you want to run on, e.g., features/*
