version: 2.1

setup: true

orbs:
  path-filtering: circleci/path-filtering@0.1.4

parameters:
  run_backend:
    type: boolean
    default: false
  run_frontend:
    type: boolean
    default: false
  run_database:
    type: boolean
    default: false

jobs:
  # --- Test Jobs ---
  backend_test:
    docker:
      - image: cimg/node:20.5.1
    steps:
      - checkout
      - run:
          name: "Run Backend Tests"
          command: |
            echo "Running backend tests..."
            cd Backend
            npm install
            npm test

  frontend_test:
    docker:
      - image: cimg/node:20.5.1
    steps:
      - checkout
      - run:
          name: "Run Frontend Tests"
          command: |
            echo "Running frontend tests..."
            cd Frontend
            npm install
            npm test

  database_test:
    docker:
      - image: cimg/postgres:16.0
    steps:
      - checkout
      - run:
          name: "Run Database Tests/Migrations"
          command: |
            echo "Running database tests..."
            cd database
            # ./run-db-tests.sh

  # --- Deploy Jobs (only on main) ---
  backend_deploy_main:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Docker Login
          command: |
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run:
          name: Build Backend Docker Image
          command: |
            docker build -t $DOCKERHUB_USERNAME/backend:latest ./Backend
      - run:
          name: Push Backend Docker Image
          command: |
            docker push $DOCKERHUB_USERNAME/backend:latest
      - run:
          name: Deploy Backend to Main (Production)
          command: |
            ./deploy-backend-main.sh

  frontend_deploy_main:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Docker Login
          command: |
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run:
          name: Build Frontend Docker Image
          command: |
            docker build -t $DOCKERHUB_USERNAME/frontend:latest ./Frontend
      - run:
          name: Push Frontend Docker Image
          command: |
            docker push $DOCKERHUB_USERNAME/frontend:latest
      - run:
          name: Deploy Frontend to Main (Production)
          command: |
            ./deploy-frontend-main.sh

  database_deploy_main:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Docker Login
          command: |
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run:
          name: Build Database Docker Image
          command: |
            docker build -t $DOCKERHUB_USERNAME/database:latest ./database
      - run:
          name: Push Database Docker Image
          command: |
            docker push $DOCKERHUB_USERNAME/database:latest
      - run:
          name: Deploy Database to Main (Production)
          command: |
            ./deploy-database-main.sh

workflows:
  check-and-run-pipelines:
    jobs:
      - path-filtering/filter:
          name: check-for-changed-files
          mapping: |
            Backend/.* run_backend true
            Frontend/.* run_frontend true
            database/.* run_database true

      # Run tests on all branches except main
      - backend_test:
          requires: [check-for-changed-files]
          when: << pipeline.parameters.run_backend >>
          filters:
            branches:
              ignore: [main]

      - frontend_test:
          requires: [check-for-changed-files]
          when: << pipeline.parameters.run_frontend >>
          filters:
            branches:
              ignore: [main]

      - database_test:
          requires: [check-for-changed-files]
          when: << pipeline.parameters.run_database >>
          filters:
            branches:
              ignore: [main]

      # Deploy only on main branch
      - backend_deploy_main:
          requires: [check-for-changed-files]
          when: << pipeline.parameters.run_backend >>
          filters:
            branches:
              only: main

      - frontend_deploy_main:
          requires: [check-for-changed-files]
          when: << pipeline.parameters.run_frontend >>
          filters:
            branches:
              only: main

      - database_deploy_main:
          requires: [check-for-changed-files]
          when: << pipeline.parameters.run_database >>
          filters:
            branches:
              only: main

